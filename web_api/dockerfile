# Oil Database Web API Docker configuration
#

FROM registry.orr.noaa.gov/erd/centos-conda

RUN echo "ip_resolve=4" >> /etc/yum.conf

RUN yum update -y

COPY ./ /adios-db/

RUN mkdir /var/lib/mongo
RUN mkdir /var/log/mongodb
RUN mkdir /var/run/mongodb

RUN cd adios-db/adios_db && conda install --file conda_requirements.txt
RUN cd adios-db/adios_db && pip install -e ./

RUN cd adios-db/adios_db/data/exxon_assays && python ./download_exxon_assays.py

RUN mongod --config adios-db/mongo_config_deploy.yml && cd adios-db/adios_db && adios_db_init
RUN mongod --config adios-db/mongo_config_deploy.yml && cd adios-db/adios_db && adios_db_import --all

RUN cd adios-db/web_api && conda install --file conda_requirements.txt
RUN cd adios-db/web_api && pip install -e ./

RUN mkdir /config
RUN cp /adios-db/web_api/config-example.ini /config/config.ini

EXPOSE 9898
VOLUME /config
ENTRYPOINT ["/adios-db/web_api/docker_start.sh"]
