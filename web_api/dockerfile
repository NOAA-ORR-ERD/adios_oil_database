# Oil Database Web API Docker configuration
#

FROM registry.orr.noaa.gov/erd/centos-conda/centos7-python3

RUN echo "ip_resolve=4" >> /etc/yum.conf

RUN yum update -y
RUN conda install -y python=3.9
RUN conda update -y conda

RUN echo $ADIOS_STAGE_CONTAINER_KEY > /root/.ssh/id_rsa
RUN cat /root/.ssh/id_rsa

RUN echo "gitlab.orr.noaa.gov ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBKAoAhgfU2DFjjRSf6B4siXwE5LdGEeNGUf+CO0WGpNmGClPbYcbVAZoAeYiORYK4zQftTkewZeaFJ6m4BFxgSM=" > /root/.ssh/known_hosts
RUN chmod og-rw /root/.ssh/known_hosts

RUN git clone ssh://git@gitlab.orr.noaa.gov:9933/gnome/oil_database/noaa-oil-data.git

COPY ./ /adios-db/
WORKDIR adios-db

# install deps
RUN conda install --file adios_db/conda_requirements.txt --file web_api/conda_requirements.txt
RUN cd adios_db && pip install -e ./
RUN cd web_api && pip install -e ./

RUN mkdir /config
RUN cp /adios-db/oildb-deploy/config/stage/web_api/* /config/

EXPOSE 9898
ENTRYPOINT ["/adios-db/web_api/docker_start.sh"]
