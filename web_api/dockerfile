# Oil Database Web API Docker configuration
#

FROM registry.orr.noaa.gov/erd/centos-conda

RUN echo "ip_resolve=4" >> /etc/yum.conf

RUN yum update -y
# RUN yum install -y redis

COPY ./ /adios-db/

RUN cp /adios-db/platform/centos/mongodb-org-4.2.repo /etc/yum.repos.d
RUN yum install mongodb-org -y

RUN cd adios-db/adios_db && conda install --file conda_requirements.txt
RUN cd adios-db/adios_db && pip install -e ./

RUN cd adios-db/adios_db/data/exxon_assays && python ./download_exxon_assays.py

RUN mongod --config adios-db/mongo_config_dev.yml --fork && cd adios-db/adios_db && adios_db_init
RUN mongod --config adios-db/mongo_config_dev.yml --fork && cd adios-db/adios_db && adios_db_import --all

RUN cd adios-db/web_api && conda install --file conda_requirements.txt
RUN cd adios-db/web_api && pip install -e ./

RUN mkdir /config
RUN cp /adios-db/web_api/config-example.ini /config/config.ini

EXPOSE 9898
VOLUME /config
ENTRYPOINT ["/adios-db/web_api/docker_start.sh"]
